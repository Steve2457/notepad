<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Á¶ªÁ∫øËÆ∞‰∫ãÊú¨</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            height: 100vh;
            display: flex;
            flex-direction: column;
            background-color: #f5f5f5;
        }

        .toolbar {
            background-color: #2c3e50;
            color: white;
            padding: 10px 20px;
            display: flex;
            gap: 10px;
            align-items: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }

        .toolbar button {
            background-color: #3498db;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: background-color 0.3s;
        }

        .toolbar button:hover {
            background-color: #2980b9;
        }

        .toolbar button:active {
            transform: scale(0.98);
        }

        .status-bar {
            background-color: #34495e;
            color: #ecf0f1;
            padding: 5px 20px;
            font-size: 12px;
            display: flex;
            justify-content: space-between;
        }

        .editor-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            padding: 20px;
            overflow: hidden;
        }

        #textEditor {
            flex: 1;
            width: 100%;
            padding: 15px;
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            font-size: 14px;
            line-height: 1.6;
            border: 1px solid #ddd;
            border-radius: 4px;
            resize: none;
            background-color: white;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        #textEditor:focus {
            outline: none;
            border-color: #3498db;
        }

        .file-input {
            display: none;
        }

        .save-path-container {
            margin-top: 10px;
            padding: 10px;
            background-color: #ecf0f1;
            border-radius: 4px;
            font-size: 12px;
        }

        .save-path-container label {
            font-weight: bold;
            margin-right: 10px;
        }

        .save-path-container input {
            flex: 1;
            padding: 5px;
            border: 1px solid #bdc3c7;
            border-radius: 3px;
            min-width: 300px;
        }

        .notification {
            position: fixed;
            top: 80px;
            right: 20px;
            background-color: #27ae60;
            color: white;
            padding: 15px 20px;
            border-radius: 4px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
            display: none;
            animation: slideIn 0.3s ease-out;
        }

        @keyframes slideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .notification.show {
            display: block;
        }

        .notification.error {
            background-color: #e74c3c;
        }

        h1 {
            color: white;
            font-size: 18px;
            /* margin-right: auto; */
        }

        .timer-wrapper {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-left: 15px;
            margin-right: auto;
            background-color: rgba(255,255,255,0.1);
            padding: 4px 10px;
            border-radius: 4px;
        }

        .timer-wrapper input {
            width: 50px;
            padding: 4px;
            border: none;
            border-radius: 3px;
            text-align: center;
            font-size: 14px;
        }

        .timer-wrapper span {
            font-family: monospace;
            font-size: 16px;
            font-weight: bold;
            min-width: 50px;
            text-align: center;
        }

        .timer-btn {
            background-color: #27ae60 !important;
            padding: 4px 10px !important;
            font-size: 13px !important;
            height: 28px;
            line-height: 1;
        }

        .timer-btn.running {
            background-color: #e67e22 !important;
        }

        .timer-btn.reset {
            background-color: #95a5a6 !important;
        }
    </style>
</head>
<body>
    <div class="toolbar">
        <h1>üìù Á¶ªÁ∫øËÆ∞‰∫ãÊú¨</h1>
        <div class="timer-wrapper">
            <input type="number" id="timerInput" value="10" min="1" max="180" onchange="resetTimer()" title="ÂàÜÈíü">
            <span id="timerDisplay">10:00</span>
            <button id="timerBtn" class="timer-btn" onclick="toggleTimer()">ÂºÄÂßã</button>            <button class="timer-btn reset" onclick="resetTimer()">ÈáçÁΩÆ</button>        </div>
        <button onclick="newFile()">Êñ∞Âª∫</button>
        <button onclick="openFile()">ÊâìÂºÄ</button>
        <button onclick="saveFile()">‰øùÂ≠ò</button>
        <button onclick="saveAsFile()">Âè¶Â≠ò‰∏∫</button>
        <button onclick="clearText()">Ê∏ÖÁ©∫</button>
    </div>

    <div class="status-bar">
        <span id="filename">Êú™ÂëΩÂêç.txt</span>
        <span id="stats">Â≠óÁ¨¶Êï∞: 0 | Ë°åÊï∞: 1</span>
    </div>

    <div class="editor-container">
        <textarea id="textEditor" placeholder="ÂºÄÂßãËæìÂÖ•ÊÇ®ÁöÑÊñáÊú¨..."></textarea>
        <div class="save-path-container">
            <label>ÈªòËÆ§Êñá‰ª∂Âêç:</label>
            <input type="text" id="defaultFilename" value="Êú™ÂëΩÂêç.txt" placeholder="ËæìÂÖ•Êñá‰ª∂Âêç">
        </div>
    </div>

    <input type="file" id="fileInput" class="file-input" accept=".txt" onchange="handleFileSelect(event)">

    <div id="notification" class="notification"></div>

    <script>
        let currentFileHandle = null;
        let hasUnsavedChanges = false;
        const textEditor = document.getElementById('textEditor');
        const filenameDisplay = document.getElementById('filename');
        const statsDisplay = document.getElementById('stats');
        const defaultFilenameInput = document.getElementById('defaultFilename');

        // Êõ¥Êñ∞ÁªüËÆ°‰ø°ÊÅØ
        function updateStats() {
            const text = textEditor.value;
            // ÁªüËÆ°ÂçïËØçÊï∞ (TOEFLÂÜô‰Ωú‰∏ªË¶ÅÂÖ≥Ê≥®ÂçïËØçÊï∞)
            const wordCount = (text.match(/\S+/g) || []).length;
            const lineCount = text.split('\n').length;
            statsDisplay.textContent = `ÂçïËØçÊï∞: ${wordCount} | Ë°åÊï∞: ${lineCount}`;
        }

        // ÊñáÊú¨ÁºñËæëÂô®ËæìÂÖ•‰∫ã‰ª∂
        textEditor.addEventListener('input', () => {
            hasUnsavedChanges = true;
            updateStats();
        });

        // ÊòæÁ§∫ÈÄöÁü•
        function showNotification(message, isError = false) {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.className = 'notification show' + (isError ? ' error' : '');
            setTimeout(() => {
                notification.className = 'notification';
            }, 3000);
        }

        // Êñ∞Âª∫Êñá‰ª∂
        function newFile() {
            if (hasUnsavedChanges) {
                if (!confirm('ÂΩìÂâçÊñáÊú¨Â∞öÊú™‰øùÂ≠òÔºåÁ°ÆÂÆöË¶ÅÊñ∞Âª∫ÂêóÔºü')) {
                    return;
                }
            }
            textEditor.value = '';
            currentFileHandle = null;
            filenameDisplay.textContent = 'Êú™ÂëΩÂêç.txt';
            defaultFilenameInput.value = 'Êú™ÂëΩÂêç.txt';
            hasUnsavedChanges = false;
            updateStats();
            showNotification('Â∑≤Êñ∞Âª∫Êñá‰ª∂');
        }

        // ÊâìÂºÄÊñá‰ª∂
        async function openFile() {
            if (hasUnsavedChanges) {
                if (!confirm('ÂΩìÂâçÊñáÊú¨Â∞öÊú™‰øùÂ≠òÔºåÁ°ÆÂÆöË¶ÅÊâìÂºÄÊñ∞Êñá‰ª∂ÂêóÔºü')) {
                    return;
                }
            }

            // Â∞ùËØï‰ΩøÁî®File System Access API
            if ('showOpenFilePicker' in window) {
                try {
                    const [fileHandle] = await window.showOpenFilePicker({
                        types: [{
                            description: 'ÊñáÊú¨Êñá‰ª∂',
                            accept: { 'text/plain': ['.txt'] }
                        }],
                        multiple: false
                    });

                    const file = await fileHandle.getFile();
                    const text = await file.text();
                    textEditor.value = text;
                    currentFileHandle = fileHandle;
                    filenameDisplay.textContent = file.name;
                    defaultFilenameInput.value = file.name;
                    hasUnsavedChanges = false;
                    updateStats();
                    showNotification('Êñá‰ª∂Â∑≤ÊâìÂºÄ: ' + file.name);
                } catch (err) {
                    if (err.name !== 'AbortError') {
                        showNotification('ÊâìÂºÄÊñá‰ª∂Â§±Ë¥•: ' + err.message, true);
                    }
                }
            } else {
                // ÈôçÁ∫ßÂà∞‰º†ÁªüÁöÑÊñá‰ª∂ËæìÂÖ•
                document.getElementById('fileInput').click();
            }
        }

        // Â§ÑÁêÜ‰º†ÁªüÊñá‰ª∂ÈÄâÊã©
        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    textEditor.value = e.target.result;
                    filenameDisplay.textContent = file.name;
                    defaultFilenameInput.value = file.name;
                    hasUnsavedChanges = false;
                    updateStats();
                    showNotification('Êñá‰ª∂Â∑≤ÊâìÂºÄ: ' + file.name);
                };
                reader.readAsText(file);
            }
        }

        // ‰øùÂ≠òÊñá‰ª∂
        async function saveFile() {
            const text = textEditor.value;

            // Â¶ÇÊûúÂ∑≤ÁªèÊúâÊñá‰ª∂Âè•ÊüÑÔºåÁõ¥Êé•‰øùÂ≠ò
            if (currentFileHandle && 'createWritable' in currentFileHandle) {
                try {
                    const writable = await currentFileHandle.createWritable();
                    await writable.write(text);
                    await writable.close();
                    hasUnsavedChanges = false;
                    showNotification('Êñá‰ª∂Â∑≤‰øùÂ≠ò');
                    return;
                } catch (err) {
                    showNotification('‰øùÂ≠òÂ§±Ë¥•: ' + err.message, true);
                    return;
                }
            }

            // Âê¶ÂàôË∞ÉÁî®Âè¶Â≠ò‰∏∫
            await saveAsFile();
        }

        // Âè¶Â≠ò‰∏∫
        async function saveAsFile() {
            const text = textEditor.value;
            const filename = defaultFilenameInput.value || 'Êú™ÂëΩÂêç.txt';

            // Â∞ùËØï‰ΩøÁî®File System Access API
            if ('showSaveFilePicker' in window) {
                try {
                    const fileHandle = await window.showSaveFilePicker({
                        suggestedName: filename,
                        types: [{
                            description: 'ÊñáÊú¨Êñá‰ª∂',
                            accept: { 'text/plain': ['.txt'] }
                        }]
                    });

                    const writable = await fileHandle.createWritable();
                    await writable.write(text);
                    await writable.close();

                    currentFileHandle = fileHandle;
                    filenameDisplay.textContent = fileHandle.name;
                    defaultFilenameInput.value = fileHandle.name;
                    hasUnsavedChanges = false;
                    showNotification('Êñá‰ª∂Â∑≤‰øùÂ≠ò');
                } catch (err) {
                    if (err.name !== 'AbortError') {
                        showNotification('‰øùÂ≠òÂ§±Ë¥•: ' + err.message, true);
                    }
                }
            } else {
                // ÈôçÁ∫ßÂà∞‰∏ãËΩΩÊñπÂºè
                downloadFile(text, filename);
            }
        }

        // ‰∏ãËΩΩÊñá‰ª∂ÔºàÈôçÁ∫ßÊñπÊ°àÔºâ
        function downloadFile(text, filename) {
            const blob = new Blob([text], { type: 'text/plain;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            hasUnsavedChanges = false;
            showNotification('Êñá‰ª∂Â∑≤‰∏ãËΩΩÂà∞ÈªòËÆ§‰∏ãËΩΩÊñá‰ª∂Â§π');
        }

        // Ê∏ÖÁ©∫ÊñáÊú¨
        function clearText() {
            if (textEditor.value && !confirm('Á°ÆÂÆöË¶ÅÊ∏ÖÁ©∫ÊâÄÊúâÊñáÊú¨ÂêóÔºü')) {
                return;
            }
            textEditor.value = '';
            hasUnsavedChanges = true;
            updateStats();
            showNotification('ÊñáÊú¨Â∑≤Ê∏ÖÁ©∫');
        }

        // È°µÈù¢Á¶ªÂºÄÂâçÊèêÁ§∫
        window.addEventListener('beforeunload', (e) => {
            if (hasUnsavedChanges) {
                e.preventDefault();
                e.returnValue = '';
            }
        });

        // ÈîÆÁõòÂø´Êç∑ÈîÆ
        document.addEventListener('keydown', (e) => {
            // Ctrl/Cmd + S: ‰øùÂ≠ò
            if ((e.ctrlKey || e.metaKey) && e.key === 's') {
                e.preventDefault();
                saveFile();
            }
            // Ctrl/Cmd + N: Êñ∞Âª∫
            if ((e.ctrlKey || e.metaKey) && e.key === 'n') {
                e.preventDefault();
                newFile();
            }
            // Ctrl/Cmd + O: ÊâìÂºÄ
            if ((e.ctrlKey || e.metaKey) && e.key === 'o') {
                e.preventDefault();
                openFile();
            }
        });

        // ÂàùÂßãÂåñ
        updateStats();

        // ÂÄíËÆ°Êó∂ÂäüËÉΩ
        let timerInterval = null;
        let timeLeft = 10 * 60;
        let isTimerRunning = false;
        
        const timerInput = document.getElementById('timerInput');
        const timerDisplay = document.getElementById('timerDisplay');
        const timerBtn = document.getElementById('timerBtn');
        
        function formatTime(seconds) {
            const m = Math.floor(seconds / 60);
            const s = seconds % 60;
            return `${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`;
        }
        
        function resetTimer() {
            stopTimer(); // ‰øÆÊîπÊó∂Èó¥Êó∂ÂÖàÂÅúÊ≠¢
            const mins = parseInt(timerInput.value) || 30;
            timeLeft = mins * 60;
            updateTimerDisplay();
            timerBtn.textContent = 'ÂºÄÂßã';
        }
        
        function updateTimerDisplay() {
            timerDisplay.textContent = formatTime(timeLeft);
            // ÊîπÂèòÈ¢úËâ≤ÊèêÁ§∫
            if (timeLeft < 60) { // ÊúÄÂêé1ÂàÜÈíü
                timerDisplay.style.color = '#e74c3c'; // Á∫¢Ëâ≤
            } else if (timeLeft < 180) { // ÊúÄÂêé3ÂàÜÈíü
                timerDisplay.style.color = '#f1c40f'; // ÈªÑËâ≤
            } else {
                timerDisplay.style.color = 'white';
            }
        }

        function toggleTimer() {
            if (isTimerRunning) {
                stopTimer();
            } else {
                startTimer();
            }
        }
        
        function startTimer() {
            if (timeLeft <= 0) {
                resetTimer(); // Â¶ÇÊûúÊó∂Èó¥‰∏∫0ÔºåÈáçÁΩÆ‰∏∫ËæìÂÖ•Ê°ÜÁöÑÂÄº
            }
            
            isTimerRunning = true;
            timerBtn.textContent = 'ÊöÇÂÅú';
            timerBtn.className = 'timer-btn running';
            timerInput.disabled = true;
            
            timerInterval = setInterval(() => {
                timeLeft--;
                updateTimerDisplay();
                
                if (timeLeft <= 0) {
                    stopTimer();
                    showNotification('‚è∞ ÂÜô‰ΩúÊó∂Èó¥Âà∞ÔºÅ', true);
                    // ‰πüÂèØ‰ª•Âú®ËøôÈáåÊ∑ªÂä†Èü≥È¢ëÊèêÁ§∫
                    timerBtn.textContent = 'ÁªìÊùü';
                }
            }, 1000);
        }
        
        function stopTimer() {
            isTimerRunning = false;
            clearInterval(timerInterval);
            if (timeLeft > 0) {
                timerBtn.textContent = 'ÁªßÁª≠';
            } else {
                timerBtn.textContent = 'ÂºÄÂßã';
            }
            timerBtn.className = 'timer-btn';
            timerInput.disabled = false;
        }
    </script>
</body>
</html>
